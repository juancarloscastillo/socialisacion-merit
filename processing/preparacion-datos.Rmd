---
title: "Preparación de datos - Socialización de la meritocracia"
author: "Castillo, J.C., Iturra, J., Meneses, F. & Venegas, M."
date: '`r Sys.Date()`'
output:
  html_document:
    df_print: paged
    theme: readable
    toc: yes
    toc_float: no
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

# Introducción

El presente documento tiene por finalidad la preparación de datos del artículo en proceso "La socialización de la meritocracia: el rol de la familia y la escuela" a cargo de Juan Carlos Castillo. El artículo se desarrolla en el marco del proyecto FONDECYT Regular N°1181239: "Socialización política y educación para la ciudadanía: el rol de la familia y de la escuela."  

La estructura para la preparación consistirá en cinco partes. La primera corresponde a cargar las librerías de R para la elaboración del documento. En la segunda se cargará la base de datos. En la tercera se seleccionarán las variables a utilizar. En la cuarta, dónde estará el grueso del documento, se procesarán las variables. El procesamiento se divirá en torno a variables relacionadas a padres y a estudiantes. Para ambas, se seguirá el siguiente orden: descriptivo, recodificación, etiquetado, descriptivo post-rec y otros ajustes. Además, al lado de cada variable figurará un entreparentesis indicando si corresponde a una variable independiente (Var. Indep.), dependiente (Var. Dep.) o un control (Control) de nivel uno (N1) o dos (N2) Por último, se generará una base de datos procesada para los análisis posteriores, en conjunto a una tabla de descriptivos para la base completa.

# Resumen ejecutivo:
Se listan los puntos mas importantes:

## Registro para revisar
- Para la variable de promedios (obtenido y merecido) existían datos menores a 1 y mayores a 7. En detalle, existían 6 casos para el promedio obtenido y 12 casos para el promedio merecido que no se ajustan a la escala. Provisoriamente fueron recodificados a NA.

- Para la variable de año de nacimiento del apoderado existían datos poco probables. En detalle, existían 10 casos que indican años mayores a 1992. Provisoriamente fueron recodificados a NA.

- ~~Variables de nivel 2 (ingresos por escuela, educación terciaria por escuela y heterogeneidad) cuentan con demasiados NA. Revisar código.~~

- Dos cosas importantes sobre la variable ingresos. La primera es que existen 148 casos correspondientes a NS/NR que han sido recodificados a NA, discutir mantener categoría. La segunda es que en ingresos nivel dos solo existen 7 NA, pertenecientes a los RBD 10452 (solo contestaron estudiantes) y 31047 (ninguno de los seis apoderados de este colegio reportaron sus ingresos). 

## Registro de cambios desde reunión 21-1-21:
- Cambio presentación de las variables. Se dividen entre variables estudiantes y apoderados.
- Se modifica la introducción en función del cambio de estructura.
- Cambio etiquetas variables percepción meritocracia. Se asignan etiquetas más intuitivas para los indicadores.
- Se agrega código de frecuencias posterior a la recodificación por cada variable.
- Se añade tabla descriptiva general, la cual incluye NA's.
- Se arregla construcción de ingreso del hogar. Faltaba una categoría por codificar.
- Se recodifican los valores 8 y 9 en Ns/Nr para las variables de posición política.
- Se desactiva indice flotante ya que choca con la tabla de summarytools.
- Se agregan variables para nueva propuesta
- Se arregla caso mal pareado (897 estudiante). Era un error de tipeo, aunque no cambia el N.
- Se crean variables promedios de percepción meritocrática (en estudiantes y apoderados)
- Se incorpora código detallado sobre nivel educacional. Creación de variables filtrando por sexo del apoderado.

# Procesamiento
## Parte 1: Cargar librerías  

Las librerías a utilizar para la elaboración del documento serán:

- *dplyr:* ajuste general de datos
- *sjmisc:* descripción y exploración de base de datos
- *car:* principalmente la función recode para recodificar/agrupar valores de variable
- *stargazer:* para tabla descriptiva  
- *haven:* leer archivos .dta
- *SciViews:* cálculos básicos de matemáticas
- *summarytools:* tablas descriptivas

```{r}
pacman::p_load(dplyr, sjmisc, car, sjlabelled, stargazer, SciViews, summarytools)
```

## Parte 2: Cargar datos
```{r}
# Bases de apoderados.
ap <- haven::read_dta("https://github.com/formacionciudadana/data-paces/raw/main/docs/paces/data/base_apoderadosv2.dta")

# Base de estudiantes.
est <- haven::read_dta("https://github.com/formacionciudadana/data-paces/raw/main/docs/paces/data/base_estudiantesv2.dta")

# Arreglar caso 897
ap$FOLIO_EST[ap$FOLIO_EST == 897] <- 892

```

## Parte 3: Seleccionar variables

```{r}

# Seleccionar  y renombrar variables de la base de datos de apoderados
ap_proc <- ap %>% dplyr::select(rbd = RBD,
                                folio = FOLIO_EST,
                               region = REGION,
                               dependencia = Dependencia,
                               pos_pol = P23,
                               genero = P39,
                               nacimiento = P40A,
                               personas_hogar = P41,
                               educ = P45,
                               ingresos_tramos = P55,
                               libros_hogar = P47,
                               perc_trabajo_duro = P9D,
                               perc_familia_rica = P9A,
                               perc_esfuerzo = P10D,
                               recompensa_hijos = P10C,
                               perc_falta_talento = P11A,
                               perc_falta_esfuerzo = P11C,
                               perc_faltasist_econ =P11D,
                               perc_faltasist_educ =P11E) 

# Seleccionar y renonbrar variables de la base de datos de estudiantes.                               
est_proc <- est  %>% dplyr::select(rbd = RBD,
                                 region = REGION,
                                 folio = FOLIO,
                                 dependencia = Dependencia,
                                 pos_pol = P59,
                                 genero = P58,
                                 educ_padre = P66,
                                 educ_madre = P67,
                                 libros_hogar = P68,
                                 perc_trabajo_duro = P24D,
                                 perc_familia_rica = P24A,
                                 perc_esfuerzo = P25D,
                                 prom_obt = P27,
                                 prom_mer = P28,
                                 sj_direct = P29,
                                 recompensa = P25C,
                                 perc_falta_talento = P26A,
                                 perc_falta_esfuerzo = P26C,
                                 perc_faltasist_econ =P26D,
                                perc_faltasist_educ =P26E) 
                                 
                                 
```

## Parte 4: Procesamiento
### Variables estudiantes

#### Percepción meritocratica estudiantes: Importancia trabajo duro (Var. Dep. N1)
##### Descriptivo
```{r}
frq(est_proc$perc_trabajo_duro) # Frecuencias
table(est_proc$perc_trabajo_duro)
```

##### Recodificación
Se recodifica a NA las categorías 5 y 9, correspondiente a las etiquetas "Marca más de 1 alternativa" y "Nr".

```{r}
est_proc$perc_trabajo_duro <- set_na(est_proc$perc_trabajo_duro, na = c(5,9), drop.levels = TRUE, as.tag = FALSE) # Transformar a NA
```


##### Etiquetado

```{r}
est_proc$perc_trabajo_duro <- set_label(x = est_proc$perc_trabajo_duro,label = "Percepcion meritocracia: Importancia trabajo duro estudiantes") # Etiquetar
```

##### Descriptivo post-rec

```{r}
frq(est_proc$perc_trabajo_duro) # Frecuencias post recodificación
```

##### Otros ajustes
No aplica.

#### Percepción meritocratica estudiantes: Esfuerzo para salir adelante (Var. Dep. N1)

##### Descriptivo
```{r}
frq(est_proc$perc_esfuerzo)
```

##### Recodificación
Se recodifica a NA las categorías 5 y 9, correspondiente a las etiquetas "Marca más de 1 alternativa" y "Nr".

```{r}
est_proc$perc_esfuerzo <- set_na(est_proc$perc_esfuerzo, na = c(5,9), drop.levels = TRUE, as.tag = FALSE)
```

##### Etiquetado
```{r}
est_proc$perc_esfuerzo <- set_label(x = est_proc$perc_esfuerzo, label = "Percepcion meritocracia: Esfuerzo para salir adelante estudiantes")
```

##### Descriptivo post-rec
```{r}
frq(est_proc$perc_esfuerzo)
```

##### Otros ajustes
Creación variable: promedio de percepción de meritocracia en estudiantes
```{r}
# Crear variable
est_proc$prom_percmer_est <- ((est_proc$perc_trabajo_duro + est_proc$perc_esfuerzo)/2)

# Etiquetar
ap_proc$prom_percmer_ap <- set_label(x = ap_proc$prom_percmer_ap, label = "Promedio percepcion meritocratica estudiantes")
```


#### Sentido de justicia (indirecto): Promedio obtenido y merecido (Var. Indep. N1)
##### Descriptivo
```{r}
# Promedio obtenido
summary(est_proc$prom_obt) # Descriptivo
frq(est_proc$prom_obt)



# Promedio merecido
summary(est_proc$prom_mer)
frq(est_proc$prom_mer)
```

##### Recodificación
Se recodifica a NA las siguientes situaciones:
- Datos 99, correspondiente a No responde.
- Datos menores a 1
- Datos mayores a 7

```{r}
# Promedio obtenido
est_proc$prom_obt[est_proc$prom_obt == 99] <- NA
est_proc$prom_obt[est_proc$prom_obt < 1 | est_proc$prom_obt > 7] <- NA

# Promedio merecido
est_proc$prom_mer[est_proc$prom_mer == 99] <- NA
est_proc$prom_mer[est_proc$prom_mer < 1 | est_proc$prom_mer > 7] <- NA

```

##### Etiquetado
```{r}
# Promedio obtenido
est_proc$prom_obt <- set_label(x = est_proc$prom_obt, label = "Promedio obtenido") 

# Promedio merecido
est_proc$prom_mer <- set_label(x = est_proc$prom_mer, label = "Promedio merecido") 
```

##### Descriptivio post-rec
```{r}
# Promedio obtenido
summary(est_proc$prom_obt) # Descriptivo
frq(est_proc$prom_obt)

# Promedio merecido
summary(est_proc$prom_mer)
frq(est_proc$prom_mer)
```

##### Otros ajustes
Se elaboran dos variables nuevas a partir del cálculo para evaluación de justicia de Jasso (1980). La primera corresponde al logaritmo natural de la proporción entre el promedio obtenido y el promedio merecido. La segunda corresponde a la misma proporción sin el logaritmo.

```{r}
# Cálculo sentido justicia original
est_proc$sj_indirect_ln <-  ln(est_proc$prom_obt/est_proc$prom_mer)

# Cálculo sentido justicia sin ln
est_proc$sj_indirect_noln <-  est_proc$prom_obt/est_proc$prom_mer

##### ---- Descriptivos variables nuevas ----
# Sentido de justicia
summary(est_proc$sj_indirect_ln)

# Sentido de justicia sin ln
summary(est_proc$sj_indirect_noln)

##### ---- Etiquetado varibles nuevas ----
# Sentido de justicia
est_proc$sj_indirect_ln <- set_label(x = est_proc$sj_indirect_ln, label = "Sentido de justicia indirecto")

# Sentido de justicia sin ln
est_proc$sj_indirect_noln <- set_label(x = est_proc$sj_indirect_ln, label = "Sentido de justicia indirecto SIN LN")
```

#### Sentido de justicia (directo) (Var. Indep. N1)
##### Descriptivo
```{r}
frq(est_proc$sj_direct)
summary(est_proc$sj_direct)
```

##### Recodificación
Se transforma a NA los valores 4 y 9, correspondientes a las categorías "Marca mas de una alternativa" y "Nr"

```{r}
est_proc$sj_direct <- set_na(est_proc$sj_direct, na = c(4,9), drop.levels = TRUE, as.tag = FALSE)
```

##### Etiquetado
```{r}
est_proc$sj_direct <- set_label(x = est_proc$sj_direct, label = "Sentido de justicia directo")
```

##### Otros ajustes
No aplica.

#### NSE: Educacion (Var. Indep. N1)
##### Descriptivo
```{r}
# Cuestionario estudiantes
frq(est_proc$educ_madre)
frq(est_proc$educ_padre)
```
##### Recodificacion
Se transforma el valor 9 (Nr) y el 8 (Marca mas de 1 alternativa) en NA em ambas variables.

```{r}
# Cuestionario estudiantes
est_proc$educ_madre <- set_na(est_proc$educ_madre, na = c(8,9), drop.levels = TRUE, as.tag = FALSE)

est_proc$educ_padre <- set_na(est_proc$educ_padre, na = c(8,9), drop.levels = TRUE, as.tag = FALSE)
```

##### Etiquetado
```{r}
# Cuestionario estudiantes
est_proc$educ_madre <- set_label(x = est_proc$educ_madre, label = "Educacion de la madre")

est_proc$educ_padre <- set_label(x = est_proc$educ_padre, label = "Educacion de la madre")
```

##### Descriptivo post-rec
```{r}
# Cuestionario estudiantes
frq(est_proc$educ_madre)
frq(est_proc$educ_padre)
```

##### Otros ajustes
No aplica.

#### Género (Control N1)
##### Descriptivo
```{r}
# Genero estudiantes
frq(est_proc$genero)
```

##### Recodificación
Se transforman los valores 4 y 9, correspondientes a las categorías "Marca mas de 1 alternativa" y "Nr".

```{r}
# Genero estudiantes
est_proc$genero <- set_na(est_proc$genero, na = c(4,9), drop.levels = TRUE, as.tag = FALSE)
```

##### Etiquetado
```{r}
# Genero estudiantes
est_proc$genero <- set_label(x = est_proc$genero, label = "Genero estudiantes")
```

##### Descriptivo post-rec
```{r}
# Genero estudiantes
frq(est_proc$genero)
```

##### Otros ajustes
No aplica.

#### Posición política (Control N1)
##### Descriptivo
```{r}
# Posición política estudiantes
frq(est_proc$pos_pol)
summary(est_proc$pos_pol)
```

##### Recodificación
Se recodifican a "Ns/Nr" los valores 8 (No sabe) y 9 (Nr). Los valores 88 (Marca más de una alternativa) se recodifican a NA 

```{r}
# Posición política estudiantes
est_proc$pos_pol[est_proc$pos_pol == 8 | est_proc$pos_pol == 9] <- 99
est_proc$pos_pol <- set_labels(est_proc$pos_pol,
            labels=c("Derecha" = 1,
                     "Centro derecha" = 2,
                     "Centro" = 3,
                     "Centro Izquierda" = 4,
                     "Izquierda" = 5,
                     "Independiente" = 6,
                     "Ninguna" = 7,
                     "Ns/Nr"=99)) #Etiquetado categorías
est_proc$pos_pol<- set_na(est_proc$pos_pol, na = c(88), drop.levels = TRUE, as.tag = FALSE)
```

##### Etiquetado
```{r}
# Posición política estudiantes
est_proc$pos_pol <- set_label(x = est_proc$pos_pol, label = "Posicion politica estudiantes")
```

##### Descriptivo post-rec
```{r}
# Posición política estudiantes
frq(est_proc$pos_pol)
summary(est_proc$pos_pol)
```

##### Otros ajustes
No aplica.

#### Cantidad de libros en el hogar (Control N1)
##### Descriptivo
```{r}
# Cuestionario estudiantes
frq(est_proc$libros_hogar)
```

##### Recodificación
Se transforma el valor 9 (Nr) y el valor 8 (Marca mas de 1 alternativa) en NA.

```{r}
#Cuestionario estudiantes
est_proc$libros_hogar <- set_na(est_proc$libros_hogar, na = c(9,8), drop.levels = TRUE, as.tag = FALSE)
```

##### Etiquetado
```{r}
# Cuestionaro estudiantes 
est_proc$libros_hogar <- set_label(x = est_proc$libros_hogar, label = "Libros en el hogar estudiantes")
```

##### Descriptivo
```{r}
# Cuestionario estudiantes
frq(est_proc$libros_hogar)
```

##### Otros ajustes 
No aplica.

#### Region (Control N1)
##### Descriptivo
```{r}
# Cuestionario estudiantes
frq(est_proc$region)
```

##### Recodificación
No aplica.

##### Etiquetado
```{r}
# Cuestionario estudiantes
est_proc$region <- set_label(x = est_proc$region, label = "Region")
```

##### Descriptivo post-rec
No aplica.

##### Otros ajustes
No aplica.

#### Recompensa (Control N1)
##### Descriptivo 
```{r}
# Cuestionario estudiante
frq(est_proc$recompensa)
```

##### Recodificacion.
Se transforman los valores 9 (Nr) y 5 (Marca mas de una alternativa) a NA.

```{r}
# Cuestionario estudiantes
est_proc$recompensa <- set_na(est_proc$recompensa, na = c(5,9), drop.levels = TRUE, as.tag = FALSE)
```

##### Etiquetado
```{r}
# Cuestionario estudiantes
est_proc$recompensa <- set_label(x = est_proc$recompensa, label = "Recompensa en la escuela estudiantes")
```

##### Descriptivo post-rec
```{r}
# Cuestionario estudiante
frq(est_proc$recompensa)
```

##### Otros ajustes
No aplica.

#### Dependencia administrativa escuela (Control N2)
##### Descriptivo
```{r}
# Cuestionario estudiantes
frq(est_proc$dependencia)
summary(est_proc$dependencia)
```

##### Recodificación
No aplica.

##### Etiquetado
No aplica

##### Descriptivo post-rec
No aplica.

##### Otros ajustes
No aplica.

### Variables apoderados

#### Percepción meritocratica apoderados: Importancia trabajo duro (Var. Indep. N1)
##### Descriptivo
```{r}
frq(ap_proc$perc_trabajo_duro)
```

##### Recodificación
Se recodifica a NA la categoría 9, correspondiente a la etiquetas "Nr".

```{r}
ap_proc$perc_trabajo_duro <- set_na(ap_proc$perc_trabajo_duro, na = c(9), drop.levels = TRUE, as.tag = FALSE)
```

##### Etiquetado
```{r}
ap_proc$perc_trabajo_duro <- set_label(x = ap_proc$perc_trabajo_duro,label = "Percepcion meritocracia: Importancia trabajo duro apoderados")
```

##### Descriptivo post-rec
```{r}
frq(ap_proc$perc_trabajo_duro)
```

##### Otros ajustes
Creación variable: promedio de percepción de meritocracia en apoderados
```{r}
# Crear variable
ap_proc$prom_percmer_ap <- ((ap_proc$perc_trabajo_duro + ap_proc$perc_esfuerzo)/2)

# Etiquetar
ap_proc$prom_percmer_ap <- set_label(x = ap_proc$prom_percmer_ap, label = "Promedio percepcion meritocratica apoderados")
```

#### Percepción meritocratica apoderados: Esfuerzo para salir adelante (Var. Indep. N1)

##### Descriptivo
```{r}
frq(ap_proc$perc_esfuerzo)
```

##### Recodificación
Se recodifica a NA la categoría 9, correspondiente a la etiqueta "Nr".

```{r}
ap_proc$perc_esfuerzo <- set_na(ap_proc$perc_esfuerzo, na = c(9), drop.levels = TRUE, as.tag = FALSE)
```

##### Etiquetado
```{r}
ap_proc$perc_esfuerzo <- set_label(x = ap_proc$perc_esfuerzo, label = "Percepcion meritocracia: Esfuerzo para salir adelante apoderados")
```

##### Descriptivo post-rec
```{r}
frq(ap_proc$perc_esfuerzo)
```

##### Otros ajustes
No aplica.

#### NSE: Ingreso (Var. Indep. N1)

##### Descriptivo
```{r}
frq(ap_proc$ingresos_tramos)
```

##### Recodificación
Se juntan los números 12 y 13, correspondiente a las categorías "No sabe" y "No responde", respectivamente.
```{r}
# Ingresos tramos
ap_proc$ingresos_tramos[ap_proc$ingresos_tramos == 12 | ap_proc$ingresos_tramos == 13] <- 99

# Etiquetar
ap_proc$ingresos_tramos <- set_label(x = ap_proc$ingresos_tramos, label = c("Menos de $101.000 mensuales líquidos" = 1,
                                                                            "De $101.001 a $134.000 mensuales líquidos" = 2,
                                                                            "De $134.001 a $179.000 mensuales líquidos" = 3,
                                                                            "De $179.001 a $224.000 mensuales líquidos" = 4,
                                                                            "De $224.001 a $291.000 mensuales líquidos" = 5,
                                                                            "De $291.001 a $358.000 mensuales líquidos" = 6,
                                                                            "De $358.001 a $448.000 mensuales líquidos" = 7,
                                                                            "De $448.001 a $1.000.000 mensuales líquidos" = 8,
                                                                            "De $1.000.001 a $2.000.000 mensuales líquidos" = 9,
                                                                            "De $2.000.001 a $3.000.000 mensuales líquidos" = 10,
                                                                            "Ns/Nr"=99))
# Drop levels
ap_proc$ingresos_tramos <- set_na(ap_proc$ingresos_tramos, na = c(12,13), drop.levels = TRUE, as.tag = FALSE)
```

##### Etiquetado
```{r}
ap_proc$ingresos_tramos <- set_label(x = ap_proc$ingresos_tramos,label = "Ingresos del hogar en tramos")
```

##### Descriptivo post-rec
```{r}
frq(ap_proc$ingresos_tramos)
```

##### Otros ajustes

Se construyen dos variables nuevas. La primera es el ingreso a partir de las marcas de clase de los tramos de ingreso. La segunda es el ingreso per capita.

```{r}
# Construcción ingresos numerico

ap_proc$ingresos[ap_proc$ingresos_tramos == 1] <- 50500 
ap_proc$ingresos[ap_proc$ingresos_tramos == 2] <- 117500
ap_proc$ingresos[ap_proc$ingresos_tramos == 3] <- 156500
ap_proc$ingresos[ap_proc$ingresos_tramos == 4] <- 201500
ap_proc$ingresos[ap_proc$ingresos_tramos == 5] <- 257500
ap_proc$ingresos[ap_proc$ingresos_tramos == 6] <- 324500
ap_proc$ingresos[ap_proc$ingresos_tramos == 7] <- 403000
ap_proc$ingresos[ap_proc$ingresos_tramos == 8] <- 724000
ap_proc$ingresos[ap_proc$ingresos_tramos == 9] <- 1500000
ap_proc$ingresos[ap_proc$ingresos_tramos == 10] <- 2500000
ap_proc$ingresos[ap_proc$ingresos_tramos == 11] <- 3500000

# Construcción ingreso per capita
ap_proc$ingresos_pc <- ap_proc$ingresos/ap_proc$personas_hogar
ap_proc$ingresos_pc <- trunc(ap_proc$ingresos_pc)

# ---- Descripción variables nuevas ----

# ingreso
summary(ap_proc$ingresos)

# ingreso per capita
summary(ap_proc$ingresos_pc)

#---- Etiquetado variables nuevas ----
#ingreso
ap_proc$ingresos <- set_label(x = ap_proc$ingresos, label = "Ingresos del hogar")

# ingreso per capita
ap_proc$ingresos_pc <- set_label(x = ap_proc$ingresos_pc, label = "Ingreso per capita")
```

#### NSE: Educación (Var. Indep. N1)
##### Descriptivo
```{r}
# Cuestionario apoderados
frq(ap_proc$educ)
``` 

##### Recodificacion
Se transforma a NA el valor 9 (Nr).

```{r}
# Cuestionario apoderados
ap_proc$educ <- set_na(ap_proc$educ, na = c(9), drop.levels = TRUE, as.tag = FALSE)
```

##### Etiquetado
```{r}
# Cuestionario apoderados
ap_proc$educ <- set_label(x = ap_proc$educ, label = "Educacion del apoderado")
```

##### Descriptivo post-rec
```{r}
# Cuestionario apoderados
frq(ap_proc$educ)
```

##### Otros ajustes

# Nivel educacional de los padres
## Nivel educacional de los padres priorizando información reportada por apoderados
```{r}
# Nivel educacional reportado por apoderados
summary(ap_proc$educ)
```

```{r}
# Nivel educacional más alto reportado por estudiantes

est_proc$educ_ap <- est_proc %>% 
             filter(educ_padre == max(educ_padre) | educ_madre == max(educ_madre))


summary(est_proc$educ_padre)
summary(est_proc$educ_madre)
```

```{r}
# Guardar respuestas del nivel educacional de los padres. Si no respondió, se incluye la respuesta más alta reportada por los estudiantes.
data$Ed_apod <- ifelse(is.na(data$Educacion), data$Ed_padres, data$Educacion)
data$Ed_apod <- set_label(x = data$Ed_apod,label = "Nivel educacional de los apoderados")
summary(data$Ed_apod)
```

```{r}
## Nivel educacional de los padres priorizando información reportada por apoderados y diferenciando por género del apoderado
## Filtrar base de datos por sexo del apoderado (padre)
data_pad = data %>%  filter(Sexo_apod==1) %>% as.data.frame()
## Guardar las respuestas nivel educativo de los padres que respondieron la encuesta; si no la respondió, se incluye lo reportado por alumno
data_pad$Educ_padre <- ifelse((is.na(data_pad$Educacion)), data_pad$Ed_padre, data_pad$Educacion)
data_pad = data_pad %>% dplyr::select(FOLIO, Educ_padre) %>% as.data.frame()
data <- left_join(x = data, y = data_pad, by=c("FOLIO"))
```

```{r}
#Padre
data$Educ_padre <- ifelse(is.na(data$Educ_padre), data$Ed_padre, data$Educ_padre)
data$Educ_padre <- set_label(x = data$Educ_padre,label = "Nivel educacional del padre")
summary(data$Educ_padre)
```

```{r}
## Filtrar base de datos por sexo del apoderado (madre)
data_mad = data %>%  filter(Sexo_apod==2) %>% as.data.frame()
## Guardar las respuestas nivel educativo de las madres que respondieron la encuesta; si no la respondió, se incluye lo reportado por alumno
data_mad$Educ_madre <- ifelse((is.na(data_mad$Educacion)), data_mad$Ed_madre, data_mad$Educacion)
data_mad = data_mad %>% dplyr::select(FOLIO, Educ_madre) %>% as.data.frame()
data <- left_join(x = data, y = data_mad, by=c("FOLIO"))
```

```{r}
#Madre
data$Educ_madre <- ifelse(is.na(data$Educ_madre), data$Ed_madre, data$Educ_madre)
data$Educ_madre <- set_label(x = data$Educ_madre,label = "Nivel educacional de la madre")
summary(data$Educ_madre)
```

#### Edad (Var. Indep. N1)
##### Descriptivo
```{r}
# Edad apoderados
frq(ap_proc$nacimiento)
```

##### Recodificación
Se transforman a NA los valores 9999, correspondientes a la categoría "Nr". Provisoriamente, se transforman los años posteriores a 1992 a NA. Como referencia, un apoderado nacido en 1992 tendría 27 años al momento que su hijo tenga 16.

```{r}
ap_proc$nacimiento[ap_proc$nacimiento == 9999] <- NA
ap_proc$nacimiento[ap_proc$nacimiento > 1992] <- NA
```

##### Etiquetado
```{r}
ap_proc$nacimiento <- set_label(x = ap_proc$nacimiento, label = "Nacimiento apoderado")
```

##### Descriptivo post-rec
```{r}
# Edad apoderados
frq(ap_proc$nacimiento)
```

##### Otros ajustes
Se crea variable edad númerica.

```{r}
# Crear variable edad
ap_proc$edad <- 2019 - ap_proc$nacimiento

# ---- Descriptivo nueva variable ----
summary(ap_proc$edad)

# ---- Etiquetado variables nuevas ----
ap_proc$edad <- set_label(x = ap_proc$edad, label = "Edad apoderado")
```

#### Género (Control N1)
##### Descriptivo
```{r}
# Genero apoderados
frq(ap_proc$genero)
```

##### Recodificación
Se transforma el valor 9 (Nr).

```{r}
# Genero apoderados
ap_proc$genero <- set_na(ap_proc$genero, na = c(9), drop.levels = TRUE, as.tag = FALSE)
```

##### Etiquetado
```{r}
# Genero apoderados
ap_proc$genero <- set_label(x = ap_proc$genero, label = "Genero apoderados")
```

##### Descriptivo post-rec
```{r}
# Genero apoderados
frq(ap_proc$genero)
```

##### Otros ajustes
No aplica.

#### Posición política (Control N1)
##### Descriptivo
```{r}
# Posición política apoderados
frq(ap_proc$pos_pol)
summary(ap_proc$pos_pol)
```

##### Recodificación
Se recodifican a "Ns/Nr" los valores 8 (No sabe) y 9 (Nr).

```{r}
# Posicion politica apoderados
ap_proc$pos_pol[ap_proc$pos_pol == 8 | ap_proc$pos_pol == 9] <- 10
ap_proc$pos_pol <- set_labels(ap_proc$pos_pol,
            labels=c("Derecha" = 1,
                     "Centro derecha" = 2,
                     "Centro" = 3,
                     "Centro Izquierda" = 4,
                     "Izquierda" = 5,
                     "Independiente" = 6,
                     "Ninguna" = 7,
                     "Ns/Nr"=10)) #Etiquetado categorías
```

##### Etiquetado
```{r}
# Posición política apoderados
ap_proc$pos_pol <- set_label(x = ap_proc$pos_pol, label = "Posicion politica apoderados")
```

##### Descriptivo post-rec
```{r}
# Posición política apoderados
frq(ap_proc$pos_pol)
summary(ap_proc$pos_pol)
```

##### Otros ajustes
No aplica.

#### Cantidad de libros en el hogar (Control N1)
##### Descriptivo
```{r}
# Cuestionario apoderados
frq(ap_proc$libros_hogar)
```

##### Recodificación
Se transforma el valor 9 (Nr) a NA.

```{r}
# Cuestionarios apoderados
ap_proc$libros_hogar <- set_na(ap_proc$libros_hogar, na = c(9), drop.levels = TRUE, as.tag = FALSE)
```

##### Etiquetado
```{r}
# Cuestionario apoderados
ap_proc$libros_hogar <- set_label(x = ap_proc$libros_hogar, label = "Libros en el hogar apoderados")
```

##### Descriptivo post-rec
```{r}
# Cuestionario apoderados
frq(ap_proc$libros_hogar)
```

##### Otros ajustes 
No aplica.

#### Region (Control N1)

##### Descriptivo
```{r}
# Cuestionario apoderados
frq(ap_proc$region)
```

##### Recodificación
No aplica.

##### Etiquetado
```{r}
# Cuestionario apoderados
ap_proc$region <- set_label(x = ap_proc$region, label = "Region")
```

##### Descriptivo post-rec
No aplica.

##### Otros ajustes
No aplica.

#### Recompensa (Control N1)
##### Descriptivo 
```{r}
# Cuestionario apoderados
frq(ap_proc$recompensa_hijos)
```

##### Recodificacion.
Se transforman los vales 9 (Nr) a NA.

```{r}
# Cuestionario apoderados
ap_proc$recompensa_hijos <- set_na(ap_proc$recompensa_hijos, na = c(9), drop.levels = TRUE, as.tag = FALSE)
```

##### Etiquetado
```{r}
# Cuestionario apoderados
ap_proc$recompensa_hijos <- set_label(x = ap_proc$recompensa_hijos, label = "Recompensa en la escuela apoderados")
```

##### Descriptivo post-rec
```{r}
# Cuestionario apoderados
frq(ap_proc$recompensa_hijos)
```

##### Otros ajustes
No aplica.

#### Cantidad de personas en el hogar (Control N1)
##### Descriptivo
```{r}
frq(ap_proc$personas_hogar)
```

##### Recodificacion
Se transforma a NA el valor 999, correspondiente a "Nr"

```{r}
ap_proc$personas_hogar[ap_proc$personas_hogar == 999] <- NA
```

##### Etiquetado
```{r}
ap_proc$personas_hogar <- set_label(x = ap_proc$personas_hogar, label = "Cantidad de personas en el hogar")
```

##### Descriptivo post-rec
```{r}
frq(ap_proc$personas_hogar)
```

#### Otros ajustes
No aplica.

#### NSE: Ingresos por escuela (Var. Indep. N2)
##### Otros ajustes
Se construyen dos variables para el ingreso a nivel escuela. La primera a partir de la agregación del ingreso del hogar. La segunda a partir de la agregación del ingreso per capita.

```{r}

# Ingresos a nivel escuela
 ap_proc <- ap_proc %>%
     group_by(rbd) %>%
     mutate(ingresos_esc = mean(ingresos, na.rm = T))

# Ingresos per capita a nivel escuela
 ap_proc <- ap_proc %>%
     group_by(rbd) %>%
     mutate(ingresos_pc_esc = mean(ingresos_pc, na.rm = T))
 
#---- Descriptivos variables nuevas----
# Ingresos a nivel escuela
summary(ap_proc$ingresos_esc)
 
# Ingresos per capita a nivel escuela
summary(ap_proc$ingresos_pc_esc) 

#---- Etiquetado variables nuevas----
# Ingresos a nivel escuela
ap_proc$ingresos_esc <- set_label(x = ap_proc$ingresos_esc, label = "Ingresos por escuela")

# Ingresos per capita a nivel escuela
ap_proc$ingresos_pc_esc <- set_label(x = ap_proc$ingresos_pc_esc, label = "Ingreso per capita por escuela")
```

#### NSE: Educacion del apoderado por escuela (Var. Indep. N2)
##### Otros ajustes
Se construye una variable que agrega el porcentaje de apoderados con educación terciaria por escuela
```{r}
# Construcción educación terciara apoderado por escuela

ap_proc$univ<- ifelse(ap_proc$educ==4,1,0)
 ap_proc <- ap_proc %>%
     group_by(rbd) %>%
     mutate(univ_esc = mean(univ, na.rm = T))

# ---- Descriptivos nuevas variables ----
frq(ap_proc$univ)
summary(ap_proc$univ_esc)

#---- Etiquetado nuevas variables ----
ap_proc$univ <- set_label(x = ap_proc$univ, label = "Educacion terciaria apoderados") # Etiquetado variable

ap_proc$univ <- set_labels(ap_proc$univ,
            labels=c( "Universitario"=1,
                      "No universitario"=0)) #Etiquetado categorias

ap_proc$univ_esc <- set_label(x = ap_proc$univ_esc, label = "Porcentaje ed. terciaria por escuela")

```
#### Dependencia administrativa escuela (Control N2)
##### Descriptivo
```{r}
# Cuesitionarios apoderados
frq(ap_proc$dependencia)
summary(ap_proc$dependencia)
```
##### Recodificación
No aplica.

##### Etiquetado
No aplica

##### Descriptivo post-rec
No aplica.

##### Otros ajustes
No aplica.

#### Heterogeneidad socioeconómica de la escuela (Control N2)
##### Otros ajustes
Se construye variable de heterogeneidad socioeconomica de la escuela a partir del ingreso a nivel individual.
```{r}
# Construccion heterogeneidad

ap_proc <- ap_proc %>%
     group_by(rbd) %>%
     mutate(heterogen_esc = sd(ingresos, na.rm = T)) 

#---- Descriptivo variables nuevas ----

summary(ap_proc$heterogen_esc)

#---- Etiquetado variables nuevas ----
ap_proc$heterogen_esc <- set_label(x = ap_proc$heterogen_esc, label = "Heterogeneidad de la escuela")
```

## Parte 5: Merge, tabla descriptivo general y guardar bases

```{r results='asis'}
# Join

ap_est <- left_join(x = est_proc,y = ap_proc,by =c("folio"="folio"),suffix=c("_est","_ap"))

# Tabla general

print(dfSummary(ap_est, headings = FALSE,varnumbers = F),method = "render")

# Guardar base de datos conjunta

save(ap_est, file = "../input/data/ap_est.RData")

# Guardar base de datos apoderados
save(ap_proc, file = "../input/data/ap_proc.RData")

# Guardar base de datos estudiantes
save(est_proc, file = "../input/data/est_proc.RData")
```

 